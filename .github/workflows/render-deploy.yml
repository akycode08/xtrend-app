name: Conditional Render Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      backend-changed: ${{ steps.filter.outputs.backend }}
      frontend-changed: ${{ steps.filter.outputs.frontend }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # –ù—É–∂–Ω–æ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∫–æ–º–º–∏—Ç–æ–º
      
      - name: Check for backend changes
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'

  deploy-to-render:
    needs: check-changes
    runs-on: ubuntu-latest
    # –î–µ–ø–ª–æ–∏–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ backend
    if: needs.check-changes.outputs.backend-changed == 'true'
    
    steps:
      - name: Trigger Render Deployment via API
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
            echo "‚ö†Ô∏è  Warning: RENDER_API_KEY or RENDER_SERVICE_ID not set in GitHub Secrets"
            echo "üìù Please add them in: Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "‚ÑπÔ∏è  Render will deploy automatically via webhook (without this control)"
            exit 0
          fi
          
          echo "üöÄ Backend changes detected. Triggering Render deployment via API..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Render deployment triggered successfully!"
            echo "Response: $BODY"
          else
            echo "‚ùå Failed to trigger Render deployment"
            echo "HTTP Code: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

  skip-deploy:
    needs: check-changes
    runs-on: ubuntu-latest
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–µ–ø–ª–æ–π –µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤–æ frontend
    if: needs.check-changes.outputs.backend-changed == 'false' && needs.check-changes.outputs.frontend-changed == 'true'
    
    steps:
      - name: Skip Render Deployment
        run: |
          echo "‚è≠Ô∏è  Skipping Render deployment - only frontend changes detected"
          echo "‚ÑπÔ∏è  Changes in frontend/: ${{ needs.check-changes.outputs.frontend-changed }}"
          echo "‚úÖ Vercel will handle frontend deployment automatically"
